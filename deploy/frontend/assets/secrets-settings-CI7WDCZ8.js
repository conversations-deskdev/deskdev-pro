import{R as y,j as e,w as L,h as U}from"./chunk-NL6KNZEE-aMulfElY.js";import{u as $}from"./open-hands-axios-BZ-FJWYr.js";import{u as Q}from"./useQuery-C6Oy5OYj.js";import{S as C}from"./secrets-service-F4YcpXAQ.js";import{u as A}from"./use-user-providers-DfScIb2r.js";import{u as P}from"./use-config-DZtddvT8.js";import{u as T,B as p}from"./brand-button-CyoWaFBZ.js";import{S as V}from"./settings-input-DywAD7rj.js";import{c as k}from"./utils-FAyyxFNV.js";import{O as K}from"./optional-tag-jSauglgi.js";import{u as M}from"./useTranslation-bTmhRewG.js";import{F as B,a as z}from"./index-C-I75-cD.js";import{M as G}from"./modal-backdrop-BwRLozSC.js";import{I as Y}from"./declaration-DTN74MXe.js";import"./open-hands-B3E073cv.js";import"./use-settings-Bsb8Zd3z.js";import"./module-BG7DSedf.js";import"./mutation-DaRitmBy.js";import"./i18nInstance-DBIXdvxg.js";import"./iconBase-DIdAY4IJ.js";const q=()=>{const{data:t}=P(),{providers:s}=A(),a=(t==null?void 0:t.APP_MODE)==="oss";return Q({queryKey:["secrets"],queryFn:C.getSecrets,enabled:a||s.length>0})},X=()=>T({mutationFn:t=>C.deleteSecret(t)}),W=()=>T({mutationFn:({name:t,value:s,description:a})=>C.createSecret(t,s,a)}),H=()=>T({mutationFn:({secretToEdit:t,name:s,description:a})=>C.updateSecret(t,s,a)});function J({mode:t,selectedSecret:s,onCancel:a}){var j,E;const o=$(),{t:c}=M(),{data:d}=q(),{mutate:g}=W(),{mutate:N}=H(),[b,l]=y.useState(null),x=t==="edit"&&s&&((E=(j=d==null?void 0:d.find(n=>n.name===s))==null?void 0:j.description)==null?void 0:E.trim())||"",f=(n,i,r)=>{g({name:n,value:i,description:r},{onSettled:a,onSuccess:async()=>{await o.invalidateQueries({queryKey:["secrets"]})}})},h=(n,i,r)=>{o.setQueryData(["secrets"],m=>m?m.map(u=>u.name===n?{...u,name:i,description:r}:u):[])},w=()=>{o.invalidateQueries({queryKey:["secrets"]})},S=(n,i,r)=>{h(n,i,r),N({secretToEdit:n,name:i,description:r},{onSettled:a,onError:w})},v=n=>{var I,_,F;n.preventDefault();const i=new FormData(n.currentTarget),r=(I=i.get("secret-name"))==null?void 0:I.toString(),m=(_=i.get("secret-value"))==null?void 0:_.toString().trim(),u=(F=i.get("secret-description"))==null?void 0:F.toString();if(r){if(l(null),d==null?void 0:d.some(O=>O.name===r&&O.name!==s)){l(c("SECRETS$SECRET_ALREADY_EXISTS"));return}if(t==="add"){if(!m){l(c("SECRETS$SECRET_VALUE_REQUIRED"));return}f(r,m,u||void 0)}else t==="edit"&&s&&S(s,r,u||void 0)}},D=t==="add"?"add-secret-form":"edit-secret-form";return e.jsxs("form",{"data-testid":D,onSubmit:v,className:"flex flex-col items-start gap-6",children:[e.jsx(V,{testId:"name-input",name:"secret-name",type:"text",label:"Name",className:"w-full max-w-[350px]",required:!0,defaultValue:t==="edit"&&s?s:"",placeholder:c("SECRETS$API_KEY_EXAMPLE"),pattern:"^\\S*$"}),b&&e.jsx("p",{className:"text-red-500 text-sm",children:b}),t==="add"&&e.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[e.jsx("span",{className:"text-sm",children:"Value"}),e.jsx("textarea",{"data-testid":"value-input",name:"secret-value",required:!0,className:k("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed"),rows:8})]}),e.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:"Description"}),e.jsx(K,{})]}),e.jsx("input",{"data-testid":"description-input",name:"secret-description",defaultValue:x,className:k("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed")})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(p,{testId:"cancel-button",type:"button",variant:"secondary",onClick:a,children:"Cancel"}),e.jsxs(p,{testId:"submit-button",type:"submit",variant:"primary",children:[t==="add"&&c("SECRETS$ADD_SECRET"),t==="edit"&&c("SECRETS$EDIT_SECRET")]})]})]})}function R(){return e.jsxs("div",{className:"border-t border-[#717888] last-of-type:border-b max-w-[830px] pr-2.5 py-[13px] flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center justify-between w-1/3",children:[e.jsx("span",{className:"skeleton h-4 w-1/2"}),e.jsx("span",{className:"skeleton h-4 w-1/4"})]}),e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx("span",{className:"skeleton h-4 w-4"}),e.jsx("span",{className:"skeleton h-4 w-4"})]})]})}function Z({title:t,description:s,onEdit:a,onDelete:o}){return e.jsxs("tr",{"data-testid":"secret-item",className:"border-t border-[#717888] last-of-type:border-b max-w-[830px] py-[13px] flex w-full items-center",children:[e.jsx("td",{className:"w-1/4 text-sm text-content-2",children:t}),e.jsx("td",{className:"w-1/2 truncate overflow-hidden whitespace-nowrap text-sm text-content-2 opacity-80 italic",children:s||"-"}),e.jsxs("td",{className:"w-1/4 flex items-center justify-end gap-4",children:[e.jsx("button",{"data-testid":"edit-secret-button",type:"button",onClick:a,"aria-label":`Edit ${t}`,children:e.jsx(B,{size:16})}),e.jsx("button",{"data-testid":"delete-secret-button",type:"button",onClick:o,"aria-label":`Delete ${t}`,children:e.jsx(z,{size:16})})]})]})}function ee({text:t,onConfirm:s,onCancel:a}){return e.jsx(G,{onClose:a,children:e.jsxs("div",{"data-testid":"confirmation-modal",className:"bg-base-secondary p-4 rounded-xl flex flex-col gap-4 border border-tertiary",children:[e.jsx("p",{children:t}),e.jsxs("div",{className:"w-full flex gap-2",children:[e.jsx(p,{testId:"cancel-button",type:"button",onClick:a,variant:"secondary",className:"grow",children:"Cancel"}),e.jsx(p,{testId:"confirm-button",type:"button",onClick:s,variant:"primary",className:"grow",children:"Confirm"})]})]})})}function te(){const t=$(),{t:s}=M(),{data:a}=P(),{data:o,isLoading:c}=q(),{mutate:d}=X(),{providers:g}=A(),N=(a==null?void 0:a.APP_MODE)==="saas",b=g.length>0,[l,x]=y.useState("list"),[f,h]=y.useState(null),[w,S]=y.useState(!1),v=r=>{t.setQueryData(["secrets"],m=>m?m.filter(u=>u.name!==r):[])},D=()=>{t.invalidateQueries({queryKey:["secrets"]})},j=r=>{v(r),d(r,{onSettled:()=>{S(!1)},onError:D})},E=()=>{f&&j(f)},n=()=>{S(!1)},i=N&&!b;return e.jsxs("div",{"data-testid":"secrets-settings-screen",className:"px-11 py-9 flex flex-col gap-5",children:[c&&l==="list"&&e.jsxs("ul",{children:[e.jsx(R,{}),e.jsx(R,{}),e.jsx(R,{})]}),i&&e.jsx(U,{to:"/settings/integrations","data-testid":"connect-git-button",type:"button",children:e.jsx(p,{type:"button",variant:"secondary",children:s(Y.SECRETS$CONNECT_GIT_PROVIDER)})}),(o==null?void 0:o.length)===0&&l==="list"&&e.jsx("p",{"data-testid":"no-secrets-message",children:s("SECRETS$NO_SECRETS_FOUND")}),l==="list"&&e.jsx("table",{className:"w-full",children:e.jsx("tbody",{children:o==null?void 0:o.map(r=>e.jsx(Z,{title:r.name,description:r.description,onEdit:()=>{x("edit-secret-form"),h(r.name)},onDelete:()=>{S(!0),h(r.name)}},r.name))})}),!i&&l==="list"&&e.jsx(p,{testId:"add-secret-button",type:"button",variant:"primary",onClick:()=>x("add-secret-form"),isDisabled:c,children:s("SECRETS$ADD_NEW_SECRET")}),(l==="add-secret-form"||l==="edit-secret-form")&&e.jsx(J,{mode:l==="add-secret-form"?"add":"edit",selectedSecret:f,onCancel:()=>x("list")}),w&&e.jsx(ee,{text:s("SECRETS$CONFIRM_DELETE_KEY"),onConfirm:E,onCancel:n})]})}const ge=L(te);export{ge as default};
