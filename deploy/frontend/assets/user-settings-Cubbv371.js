import{w as M,r as s,j as t}from"./chunk-NL6KNZEE-aMulfElY.js";import{u as V,o as _}from"./open-hands-axios-BZ-FJWYr.js";import{u as w}from"./use-settings-Bsb8Zd3z.js";import{d as f}from"./custom-toast-handlers-zsVC4dT7.js";import{u as p}from"./useTranslation-bTmhRewG.js";import"./useQuery-C6Oy5OYj.js";import"./open-hands-B3E073cv.js";import"./module-BG7DSedf.js";import"./use-config-DZtddvT8.js";import"./index-nrxvMbfg.js";import"./i18nInstance-DBIXdvxg.js";const L=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;function j({email:a,onEmailChange:e,onSaveEmail:m,onResendVerification:E,isSaving:i,isResendingVerification:o,isEmailChanged:n,emailVerified:I,isEmailValid:c,children:u}){const{t:r}=p();return t.jsx("div",{className:"flex flex-col gap-4",children:t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("label",{className:"text-sm",children:r("SETTINGS$USER_EMAIL")}),t.jsx("div",{className:"flex items-center gap-3",children:t.jsx("input",{type:"email",value:a,onChange:e,className:`text-base text-white p-2 bg-base-tertiary rounded-sm border ${n&&!c?"border-red-500":"border-tertiary"} flex-grow focus:outline-hidden focus:border-transparent focus:ring-0`,placeholder:r("SETTINGS$USER_EMAIL_LOADING"),"data-testid":"email-input"})}),n&&!c&&t.jsx("div",{className:"text-red-500 text-sm mt-1","data-testid":"email-validation-error",children:r("SETTINGS$INVALID_EMAIL_FORMAT")}),t.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[t.jsx("button",{type:"button",onClick:m,disabled:!n||i||!c,className:"px-4 py-2 rounded-sm bg-primary text-white hover:opacity-80 disabled:opacity-30 disabled:cursor-not-allowed disabled:text-[#0D0F11]","data-testid":"save-email-button",children:r(i?"SETTINGS$SAVING":"SETTINGS$SAVE")}),I===!1&&t.jsx("button",{type:"button",onClick:E,disabled:o,className:"px-4 py-2 rounded-sm bg-primary text-white hover:opacity-80 disabled:opacity-30 disabled:cursor-not-allowed disabled:text-[#0D0F11]","data-testid":"resend-verification-button",children:r(o?"SETTINGS$SENDING":"SETTINGS$RESEND_VERIFICATION")})]}),u]})})}function C(){const{t:a}=p();return t.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-sm mt-4",role:"alert",children:[t.jsx("p",{className:"font-bold",children:a("SETTINGS$EMAIL_VERIFICATION_REQUIRED")}),t.jsx("p",{className:"text-sm",children:a("SETTINGS$EMAIL_VERIFICATION_RESTRICTION_MESSAGE")})]})}function F(){const{t:a}=p(),{data:e,isLoading:m,refetch:E}=w(),[i,o]=s.useState(""),[n,I]=s.useState(""),[c,u]=s.useState(!1),[r,x]=s.useState(!1),[N,T]=s.useState(!0),S=V(),l=s.useRef(null),A=s.useRef(void 0);s.useEffect(()=>{e!=null&&e.EMAIL&&(o(e.EMAIL),I(e.EMAIL),T(L.test(e.EMAIL)))},[e==null?void 0:e.EMAIL]),s.useEffect(()=>(l.current&&(window.clearInterval(l.current),l.current=null),A.current===!1&&(e==null?void 0:e.EMAIL_VERIFIED)===!0&&(f(a("SETTINGS$EMAIL_VERIFIED_SUCCESSFULLY")),setTimeout(()=>{S.invalidateQueries({queryKey:["settings"]})},2e3)),A.current=e==null?void 0:e.EMAIL_VERIFIED,(e==null?void 0:e.EMAIL_VERIFIED)===!1&&(l.current=window.setInterval(()=>{E()},5e3)),()=>{l.current&&(window.clearInterval(l.current),l.current=null)}),[e==null?void 0:e.EMAIL_VERIFIED,E,S,a]);const R=d=>{const h=d.target.value;o(h),T(L.test(h))},b=async()=>{if(!(i===n||!N))try{u(!0),await _.post("/api/email",{email:i},{withCredentials:!0}),I(i),f(a("SETTINGS$EMAIL_SAVED_SUCCESSFULLY")),S.invalidateQueries({queryKey:["settings"]})}catch(d){console.error(a("SETTINGS$FAILED_TO_SAVE_EMAIL"),d)}finally{u(!1)}},y=async()=>{try{x(!0),await _.put("/api/email/verify",{},{withCredentials:!0}),f(a("SETTINGS$VERIFICATION_EMAIL_SENT"))}catch(d){console.error(a("SETTINGS$FAILED_TO_RESEND_VERIFICATION"),d)}finally{x(!1)}},v=i!==n;return t.jsx("div",{"data-testid":"user-settings-screen",className:"flex flex-col h-full",children:t.jsx("div",{className:"p-9 flex flex-col gap-6",children:m?t.jsx("div",{className:"animate-pulse h-8 w-64 bg-tertiary rounded-sm"}):t.jsx(j,{email:i,onEmailChange:R,onSaveEmail:b,onResendVerification:y,isSaving:c,isResendingVerification:r,isEmailChanged:v,emailVerified:e==null?void 0:e.EMAIL_VERIFIED,isEmailValid:N,children:(e==null?void 0:e.EMAIL_VERIFIED)===!1&&t.jsx(C,{})})})})}const K=M(F);export{K as default};
